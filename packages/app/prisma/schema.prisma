generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

model AdminOrder {
  id            String   @id
  user          String
  userAddress   String?
  companionAddress String?
  item          String
  amount        Float
  currency      String
  paymentStatus String
  stage         String
  note          String?
  assignedTo    String?
  source        String?
  chainDigest   String?
  chainStatus   Int?
  serviceFee    Float?
  deposit       Float?
  meta          Json?
  createdAt     DateTime
  updatedAt     DateTime?

  @@index([createdAt])
  @@index([stage])
  @@index([paymentStatus])
  @@index([userAddress])
  @@index([chainStatus])
  @@index([assignedTo])
  @@index([companionAddress])
  @@index([source])
  @@index([companionAddress, createdAt, id])  // public orders cursor query
  @@index([userAddress, createdAt])            // user order history
}

model AdminPlayer {
  id        String   @id
  name      String
  role      String?
  contact   String?
  address   String?
  wechatQr  String?
  alipayQr  String?
  depositBase Int?
  depositLocked Int?
  creditMultiplier Int?
  creditLimit Int?
  usedCredit  Int?
  status    String
  notes     String?
  schedule  Json?    // 排班: { slots: [{ day: 0-6, start: "09:00", end: "22:00" }] }
  createdAt DateTime
  updatedAt DateTime?

  @@index([createdAt])
  @@index([status])
  @@index([address])
}

model AdminAnnouncement {
  id        String   @id
  title     String
  tag       String
  content   String
  status    String
  createdAt DateTime
  updatedAt DateTime?

  @@index([createdAt])
  @@index([status])
}

model AdminSession {
  id         String   @id
  tokenHash  String   @unique
  role       String
  label      String?
  createdAt  DateTime
  expiresAt  DateTime
  lastSeenAt DateTime?
  ip         String?
  userAgent  String?

  @@index([expiresAt])
}

model AdminAccessToken {
  id          String   @id
  tokenHash   String   @unique
  tokenPrefix String
  role        String
  label       String?
  status      String
  createdAt   DateTime
  updatedAt   DateTime?
  lastUsedAt  DateTime?

  @@index([status])
  @@index([role])
  @@index([createdAt])
}

model ChainEventCursor {
  id          String   @id
  cursor      Json?
  lastEventAt DateTime?
  createdAt   DateTime
  updatedAt   DateTime?

  @@index([createdAt])
}

model UserSession {
  id         String   @id
  tokenHash  String   @unique
  address    String
  createdAt  DateTime
  expiresAt  DateTime
  lastSeenAt DateTime?
  ip         String?
  userAgent  String?

  @@index([address])
  @@index([expiresAt])
}

model MiniProgramAccount {
  id          String   @id
  platform    String
  openid      String
  unionid     String?
  sessionKey  String?
  userAddress String?
  phone       String?
  createdAt   DateTime
  updatedAt   DateTime?
  lastLoginAt DateTime?
  meta        Json?

  @@unique([platform, openid])
  @@index([userAddress])
  @@index([unionid])
  @@index([createdAt])
}

model AdminAuditLog {
  id             String   @id
  actorRole      String
  actorSessionId String?
  action         String
  targetType     String?
  targetId       String?
  meta           Json?
  ip             String?
  createdAt      DateTime

  @@index([createdAt])
  @@index([action])
}

model AdminPaymentEvent {
  id        String   @id
  provider  String
  event     String
  orderNo   String?
  amount    Float?
  status    String?
  verified  Boolean
  createdAt DateTime
  raw       Json?

  @@index([createdAt])
  @@index([orderNo])
}

model LedgerRecord {
  id            String   @id
  userAddress   String
  diamondAmount Int
  amount        Float?
  currency      String?
  channel       String?
  status        String
  orderId       String?
  receiptId     String?
  source        String?
  note          String?
  meta          Json?
  createdAt     DateTime
  updatedAt     DateTime?

  @@index([userAddress, createdAt])
  @@index([orderId])
  @@index([receiptId])
}

model GrowthEvent {
  id         String   @id
  event      String
  clientId   String?
  sessionId  String?
  userAddress String?
  path       String?
  referrer   String?
  ua         String?
  meta       Json?
  createdAt  DateTime

  @@index([createdAt])
  @@index([event])
  @@index([userAddress])
  @@index([clientId])
}

model AdminSupportTicket {
  id          String   @id
  userName    String?
  userAddress String?
  contact     String?
  topic       String?
  message     String
  status      String
  note        String?
  meta        Json?
  createdAt   DateTime
  updatedAt   DateTime?

  @@index([createdAt])
  @@index([status])
}

model AdminCoupon {
  id          String   @id
  title       String
  code        String?
  description String?
  discount    Float?
  minSpend    Float?
  status      String
  startsAt    DateTime?
  expiresAt   DateTime?
  createdAt   DateTime
  updatedAt   DateTime?

  @@index([status])
  @@index([expiresAt])
}

model RedeemBatch {
  id               String   @id
  title            String
  description      String?
  rewardType       String
  rewardPayload    Json?
  status           String   @default("active")
  maxRedeem        Int?
  maxRedeemPerUser Int?
  totalCodes       Int?
  usedCount        Int      @default(0)
  startsAt         DateTime?
  expiresAt        DateTime?
  createdAt        DateTime
  updatedAt        DateTime?

  codes   RedeemCode[]
  records RedeemRecord[]

  @@index([status])
  @@index([createdAt])
}

model RedeemCode {
  id               String   @id
  batchId          String?
  code             String   @unique
  status           String   @default("active")
  maxRedeem        Int      @default(1)
  maxRedeemPerUser Int      @default(1)
  usedCount        Int      @default(0)
  rewardType       String?
  rewardPayload    Json?
  startsAt         DateTime?
  expiresAt        DateTime?
  note             String?
  createdAt        DateTime
  updatedAt        DateTime?
  lastRedeemedAt   DateTime?

  batch   RedeemBatch?  @relation(fields: [batchId], references: [id])
  records RedeemRecord[]

  @@index([batchId])
  @@index([status])
  @@index([createdAt])
}

model RedeemRecord {
  id          String   @id
  codeId      String
  batchId     String?
  userAddress String
  rewardType  String
  rewardPayload Json?
  status      String
  createdAt   DateTime
  ip          String?
  userAgent   String?
  meta        Json?

  code  RedeemCode  @relation(fields: [codeId], references: [id])
  batch RedeemBatch? @relation(fields: [batchId], references: [id])

  @@index([userAddress, createdAt])
  @@index([batchId])
  @@index([codeId])
}

model AdminInvoiceRequest {
  id          String   @id
  user        String?
  userAddress String?
  contact     String?
  email       String?
  orderId     String?
  amount      Float?
  title       String?
  taxId       String?
  address     String?
  status      String
  note        String?
  meta        Json?
  createdAt   DateTime
  updatedAt   DateTime?

  @@index([createdAt])
  @@index([status])
  @@index([orderId])
}

model AdminGuardianApplication {
  id          String   @id
  user        String?
  userAddress String?
  contact     String?
  games       String?
  experience  String?
  availability String?
  status      String
  note        String?
  meta        Json?
  createdAt   DateTime
  updatedAt   DateTime?

  @@index([createdAt])
  @@index([status])
  @@index([userAddress])
}

model AdminMembershipTier {
  id           String   @id
  name         String
  level        Int
  badge        String?
  price        Float?
  durationDays Int?
  minPoints    Int?
  status       String
  perks        Json?
  createdAt    DateTime
  updatedAt    DateTime?

  @@index([status])
  @@index([level])
}

model AdminMember {
  id          String   @id
  userAddress String?
  userName    String?
  tierId      String?
  tierName    String?
  points      Int?
  status      String
  expiresAt   DateTime?
  note        String?
  createdAt   DateTime
  updatedAt   DateTime?

  @@index([status])
  @@index([tierId])
  @@index([userAddress])
}

model AdminMembershipRequest {
  id          String   @id
  userAddress String?
  userName    String?
  contact     String?
  tierId      String?
  tierName    String?
  status      String
  note        String?
  meta        Json?
  createdAt   DateTime
  updatedAt   DateTime?

  @@index([status])
  @@index([tierId])
}

model MantouWallet {
  address   String   @id
  balance   Int      @default(0)
  frozen    Int      @default(0)
  createdAt DateTime
  updatedAt DateTime?

  @@index([createdAt])
}

model MantouTransaction {
  id        String   @id
  address   String
  type      String
  amount    Int
  orderId   String?
  note      String?
  createdAt DateTime

  @@index([address])
  @@index([orderId])
  @@index([createdAt])
  @@unique([orderId, type])
}

model MantouWithdrawRequest {
  id        String   @id
  address   String
  amount    Int
  status    String
  note      String?
  account   String?
  createdAt DateTime
  updatedAt DateTime?

  @@index([address])
  @@index([status])
  @@index([createdAt])
}

model Referral {
  id              String    @id
  inviterAddress  String
  inviteeAddress  String    @unique
  status          String
  rewardInviter   Int?
  rewardInvitee   Int?
  triggerOrderId  String?
  createdAt       DateTime
  rewardedAt      DateTime?

  @@index([inviterAddress])
  @@index([status])
  @@index([createdAt])
}

model ReferralConfig {
  id              String    @id @default("default")
  mode            String    @default("fixed")
  fixedInviter    Int       @default(50)
  fixedInvitee    Int       @default(30)
  percentInviter  Float     @default(0.05)
  percentInvitee  Float     @default(0.03)
  enabled         Boolean   @default(true)
  updatedAt       DateTime?
}

model OrderReview {
  id               String   @id
  orderId          String   @unique
  reviewerAddress  String
  companionAddress String
  rating           Int
  content          String?
  tags             Json?
  createdAt        DateTime

  @@index([companionAddress])
  @@index([createdAt])
}

model Notification {
  id          String   @id
  userAddress String
  type        String   // order_status, referral, system, growth
  title       String
  body        String
  orderId     String?
  read        Boolean  @default(false)
  createdAt   DateTime

  @@index([userAddress, read])
  @@index([userAddress, createdAt])
}

model UserCoupon {
  id          String    @id
  userAddress String
  couponId    String
  couponTitle String
  discount    Float?
  minSpend    Float?
  status      String    @default("unused") // unused, used, expired
  usedOrderId String?
  usedAt      DateTime?
  expiresAt   DateTime?
  createdAt   DateTime

  @@unique([userAddress, couponId])
  @@index([userAddress, status])
  @@index([couponId])
}
